name: Shipgate ISL Merge Gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

concurrency:
  group: shipgate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  shipgate-verify:
    name: ISL Evidence Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Shipgate Setup
        uses: ./.github/actions/shipgate-setup

      - name: Run Shipgate Verify
        id: shipgate
        run: |
          echo "Running shipgate verification..."
          
          # TODO: Replace with actual shipgate CLI when available
          # npx shipgate verify --json --report .shipgate/reports/ci.json
          
          # Placeholder: Generate a mock report for CI integration
          cat > .shipgate/reports/ci.json << 'EOF'
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "0.1.0",
            "verdict": "SHIP_IT",
            "summary": {
              "totalClauses": 0,
              "verified": 0,
              "partial": 0,
              "failed": 0,
              "skipped": 0
            },
            "evidence": [],
            "notes": [
              "Shipgate CLI integration pending - this is a placeholder report"
            ]
          }
          EOF
          
          # Parse the verdict from the report
          VERDICT=$(cat .shipgate/reports/ci.json | jq -r '.verdict // "UNKNOWN"')
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT
          
          # Display summary
          echo "## Shipgate Verification Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Verdict:** \`$VERDICT\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$VERDICT" = "NO_SHIP" ]; then
            echo "::error::Shipgate verification failed with verdict: NO_SHIP"
            echo "### ❌ Merge Blocked" >> $GITHUB_STEP_SUMMARY
            echo "Evidence verification failed. Please review the report below." >> $GITHUB_STEP_SUMMARY
          elif [ "$VERDICT" = "SHIP_IT" ]; then
            echo "### ✅ Ready to Merge" >> $GITHUB_STEP_SUMMARY
            echo "All ISL clauses verified successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ⚠️ Review Required" >> $GITHUB_STEP_SUMMARY
            echo "Verdict: $VERDICT - Manual review recommended." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Full Report</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat .shipgate/reports/ci.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload Evidence Report
        uses: actions/upload-artifact@v4
        with:
          name: shipgate-evidence-report
          path: .shipgate/reports/ci.json
          retention-days: 30
          if-no-files-found: warn

      - name: Check Verdict
        if: steps.shipgate.outputs.verdict == 'NO_SHIP'
        run: |
          echo "Shipgate verification returned NO_SHIP verdict"
          echo "Review the evidence report for details on failed verifications"
          exit 1

  # Optional: Comment on PR with verification results
  comment-results:
    name: Post Results to PR
    runs-on: ubuntu-latest
    needs: shipgate-verify
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - name: Download Evidence Report
        uses: actions/download-artifact@v4
        with:
          name: shipgate-evidence-report
          path: .shipgate/reports/
        continue-on-error: true

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let reportContent = '';
            let verdict = 'UNKNOWN';
            
            try {
              const report = JSON.parse(fs.readFileSync('.shipgate/reports/ci.json', 'utf8'));
              verdict = report.verdict || 'UNKNOWN';
              reportContent = JSON.stringify(report, null, 2);
            } catch (e) {
              reportContent = 'Report not available';
            }
            
            const emoji = verdict === 'SHIP_IT' ? '✅' : verdict === 'NO_SHIP' ? '❌' : '⚠️';
            const status = verdict === 'SHIP_IT' ? 'passed' : verdict === 'NO_SHIP' ? 'failed' : 'needs review';
            
            const body = `## ${emoji} Shipgate ISL Verification ${status}

            **Verdict:** \`${verdict}\`

            <details>
            <summary>Evidence Report</summary>

            \`\`\`json
            ${reportContent}
            \`\`\`

            </details>

            ---
            *This comment is automatically generated by the Shipgate merge gate.*`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Shipgate ISL Verification')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
