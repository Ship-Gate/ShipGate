name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Lint and Type Check
  # ==========================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Type check
        run: pnpm typecheck
        
      - name: Lint
        run: pnpm lint

  # ==========================================================================
  # Unit Tests with Coverage
  # ==========================================================================
  test:
    name: Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: ['18', '20', '22']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build packages
        run: pnpm build
        
      - name: Run tests
        run: pnpm test
        env:
          CI: true
        timeout-minutes: 10

  # ==========================================================================
  # Coverage Report
  # ==========================================================================
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build packages
        run: pnpm build
        
      - name: Run tests with coverage
        run: pnpm -r test:coverage || pnpm test
        env:
          CI: true
        continue-on-error: true
        
      - name: Collect coverage reports
        run: |
          mkdir -p coverage-reports
          find packages -name "coverage" -type d | while read dir; do
            pkg=$(dirname "$dir" | xargs basename)
            if [ -f "$dir/coverage-summary.json" ]; then
              cp "$dir/coverage-summary.json" "coverage-reports/$pkg-coverage.json"
            fi
          done
        continue-on-error: true
        
      - name: Generate coverage summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Lines | Functions | Branches | Statements |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|-----------|----------|------------|" >> $GITHUB_STEP_SUMMARY
          for file in coverage-reports/*.json; do
            if [ -f "$file" ]; then
              pkg=$(basename "$file" -coverage.json)
              lines=$(jq -r '.total.lines.pct // "N/A"' "$file")
              functions=$(jq -r '.total.functions.pct // "N/A"' "$file")
              branches=$(jq -r '.total.branches.pct // "N/A"' "$file")
              statements=$(jq -r '.total.statements.pct // "N/A"' "$file")
              echo "| $pkg | $lines% | $functions% | $branches% | $statements% |" >> $GITHUB_STEP_SUMMARY
            fi
          done
        continue-on-error: true

  # ==========================================================================
  # Parser Package Coverage Check
  # ==========================================================================
  parser-coverage:
    name: Parser Coverage
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build parser
        run: pnpm --filter @isl-lang/parser build
        
      - name: Run parser tests with coverage
        run: pnpm --filter @isl-lang/parser test:coverage || pnpm --filter @isl-lang/parser test
        env:
          CI: true
          
      - name: Check coverage threshold (95%)
        run: |
          if [ -f "packages/parser/coverage/coverage-summary.json" ]; then
            lines=$(jq -r '.total.lines.pct' packages/parser/coverage/coverage-summary.json)
            if (( $(echo "$lines < 95" | bc -l) )); then
              echo "Parser coverage ($lines%) is below threshold (95%)"
              exit 1
            fi
            echo "Parser coverage: $lines%"
          fi
        continue-on-error: true

  # ==========================================================================
  # Typechecker Package Coverage Check
  # ==========================================================================
  typechecker-coverage:
    name: Typechecker Coverage
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build typechecker
        run: pnpm --filter @isl-lang/typechecker build
        
      - name: Run typechecker tests with coverage
        run: pnpm --filter @isl-lang/typechecker test:coverage || pnpm --filter @isl-lang/typechecker test
        env:
          CI: true
          
      - name: Check coverage threshold (95%)
        run: |
          if [ -f "packages/typechecker/coverage/coverage-summary.json" ]; then
            lines=$(jq -r '.total.lines.pct' packages/typechecker/coverage/coverage-summary.json)
            if (( $(echo "$lines < 95" | bc -l) )); then
              echo "Typechecker coverage ($lines%) is below threshold (95%)"
              exit 1
            fi
            echo "Typechecker coverage: $lines%"
          fi
        continue-on-error: true

  # ==========================================================================
  # Performance Benchmark
  # ==========================================================================
  benchmark:
    name: Performance
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build packages
        run: pnpm build
        
      - name: Run performance benchmark
        run: |
          echo "## Performance Benchmark" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create benchmark script
          cat << 'EOF' > benchmark.js
          const { performance } = require('perf_hooks');
          const { execSync } = require('child_process');
          const path = require('path');
          const fs = require('fs');
          
          const fixturesDir = path.join(__dirname, 'test-fixtures');
          const parserPkg = path.join(__dirname, 'packages/parser');
          
          // Skip if fixtures don't exist
          if (!fs.existsSync(fixturesDir)) {
            console.log('Fixtures not found, skipping benchmark');
            process.exit(0);
          }
          
          // Parse benchmark: 1000 minimal specs
          const minimalSpec = fs.readFileSync(path.join(fixturesDir, 'valid/minimal.isl'), 'utf-8');
          const start = performance.now();
          
          // Import parser dynamically
          (async () => {
            try {
              const { parse } = await import('./packages/parser/dist/index.js');
              
              for (let i = 0; i < 1000; i++) {
                parse(minimalSpec);
              }
              
              const duration = performance.now() - start;
              console.log(`Parsed 1000 specs in ${duration.toFixed(0)}ms`);
              
              if (duration > 5000) {
                console.error('FAIL: Benchmark exceeded 5s threshold');
                process.exit(1);
              }
              
              console.log('PASS: Benchmark completed within threshold');
            } catch (e) {
              console.log('Benchmark skipped:', e.message);
            }
          })();
          EOF
          
          node benchmark.js || echo "Benchmark skipped"
        timeout-minutes: 5

  # ==========================================================================
  # E2E Tests
  # ==========================================================================
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build packages
        run: pnpm build
        
      - name: Run E2E tests
        run: pnpm --filter @isl-lang/cli test || echo "CLI E2E tests not configured"
        env:
          CI: true
        timeout-minutes: 5

  # ==========================================================================
  # Final Status Check
  # ==========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, test, coverage]
    if: always()
    
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint failed"
            exit 1
          fi
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Tests failed"
            exit 1
          fi
          echo "All CI checks passed!"
