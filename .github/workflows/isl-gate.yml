# ISL Gate Workflow
# 
# Add this workflow to any repo to gate AI-generated PRs with ISL verification.
# 
# Usage:
#   1. Copy this file to .github/workflows/isl-gate.yml
#   2. Update the spec and implementation paths
#   3. PRs will now require ISL verification to pass
#
# The gate will:
#   - Parse and type-check your ISL specs
#   - Verify implementation against spec
#   - Post results as PR comment
#   - Upload evidence bundle as artifact
#   - Block merge if NO-SHIP

name: ISL Gate

on:
  pull_request:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'specs/**'
      - '*.isl'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      spec:
        description: 'Path to ISL spec file'
        required: true
        default: 'specs/main.isl'
      implementation:
        description: 'Path to implementation'
        required: true
        default: 'src/'

jobs:
  gate:
    name: SHIP/NO-SHIP Gate
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write  # For PR comments
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run ISL Gate
        id: gate
        run: |
          echo "üö¶ ISL Gate"
          echo ""
          
          # Determine spec and impl paths
          SPEC="${{ github.event.inputs.spec || 'specs/main.isl' }}"
          IMPL="${{ github.event.inputs.implementation || 'src/' }}"
          
          echo "Spec: $SPEC"
          echo "Impl: $IMPL"
          echo ""
          
          # Check if spec exists
          if [ ! -f "$SPEC" ]; then
            echo "‚ö†Ô∏è Spec file not found: $SPEC"
            echo "Looking for .isl files..."
            find . -name "*.isl" -type f | head -5
            
            # Try to find a spec
            SPEC=$(find . -name "*.isl" -type f | head -1)
            if [ -z "$SPEC" ]; then
              echo "‚ùå No ISL spec files found"
              exit 1
            fi
            echo "Using: $SPEC"
          fi
          
          # Run the gate
          npx @isl-lang/cli gate "$SPEC" \
            --impl "$IMPL" \
            --threshold 95 \
            --output ./evidence \
            --format json > gate-result.json 2>&1 || true
          
          cat gate-result.json
          
          # Parse results
          DECISION=$(cat gate-result.json | jq -r '.decision // "NO-SHIP"')
          SCORE=$(cat gate-result.json | jq -r '.trustScore // 0')
          FINGERPRINT=$(cat gate-result.json | jq -r '.manifest.fingerprint // "unknown"')
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          if [ "$DECISION" = "SHIP" ]; then
            echo "‚úÖ SHIP"
          else
            echo "‚ùå NO-SHIP"
          fi
          echo "   Trust Score: ${SCORE}%"
          echo "   Fingerprint: ${FINGERPRINT}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Set outputs
          echo "decision=$DECISION" >> $GITHUB_OUTPUT
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "fingerprint=$FINGERPRINT" >> $GITHUB_OUTPUT

      - name: Upload Evidence
        uses: actions/upload-artifact@v4
        with:
          name: isl-evidence-${{ github.sha }}
          path: evidence/
          retention-days: 30
          if-no-files-found: warn

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const decision = '${{ steps.gate.outputs.decision }}';
            const score = '${{ steps.gate.outputs.score }}';
            const fingerprint = '${{ steps.gate.outputs.fingerprint }}';
            
            const emoji = decision === 'SHIP' ? '‚úÖ' : '‚ùå';
            
            const body = `## ${emoji} ISL Gate: ${decision}

            | Metric | Value |
            |--------|-------|
            | Trust Score | ${score}% |
            | Threshold | 95% |
            | Fingerprint | \`${fingerprint}\` |

            ${decision === 'SHIP' 
              ? '**This code passed verification and is safe to merge.**' 
              : '**This code failed verification. Please fix the issues before merging.**'}

            ---
            *Generated by ISL Gate*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('ISL Gate:')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Gate Check
        if: steps.gate.outputs.decision == 'NO-SHIP'
        run: |
          echo "‚ùå Gate failed: NO-SHIP"
          echo "Fix the verification issues and push again."
          exit 1
