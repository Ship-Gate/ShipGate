# Shipgate Gate ‚Äî GitLab CI Template
# 
# This template runs shipgate gate to verify code against ISL specifications.
# It fails the build on NO_SHIP and uploads proof bundles as artifacts.
#
# Usage:
#   include:
#     - local: 'ci-templates/gitlab/.gitlab-ci.yml'
#
# Or copy this into your .gitlab-ci.yml
#
# Configuration:
#   Set these variables in GitLab CI/CD settings or .gitlab-ci.yml:
#   - SHIPGATE_SPEC_PATH: Path to ISL spec file (default: specs/)
#   - SHIPGATE_IMPL_PATH: Path to implementation directory (default: src/)
#   - SHIPGATE_THRESHOLD: Minimum trust score (default: 95)
#   - SHIPGATE_FAIL_ON_WARN: Set to "true" to fail on warnings (default: false)

variables:
  SHIPGATE_SPEC_PATH: "${SHIPGATE_SPEC_PATH:-specs/}"
  SHIPGATE_IMPL_PATH: "${SHIPGATE_IMPL_PATH:-src/}"
  SHIPGATE_THRESHOLD: "${SHIPGATE_THRESHOLD:-95}"
  SHIPGATE_FAIL_ON_WARN: "${SHIPGATE_FAIL_ON_WARN:-false}"

shipgate-gate:
  image: node:20-slim
  stage: test
  before_script:
    # Install shipgate CLI
    - npm install -g shipgate || npm install -g @isl-lang/cli
    - shipgate --version || echo "Shipgate installed"
  script:
    # Run shipgate gate command
    - |
      echo "üö¶ Running Shipgate Gate..."
      echo "   Spec: $SHIPGATE_SPEC_PATH"
      echo "   Impl: $SHIPGATE_IMPL_PATH"
      echo "   Threshold: $SHIPGATE_THRESHOLD%"
      echo ""
      
      # Run gate command with JSON output
      set +e
      shipgate gate "$SHIPGATE_SPEC_PATH" \
        --impl "$SHIPGATE_IMPL_PATH" \
        --threshold "$SHIPGATE_THRESHOLD" \
        --output ./evidence \
        --ci \
        --format json > gate-result.json 2>&1
      EXIT_CODE=$?
      set -e
      
      # Parse result
      if [ -f gate-result.json ]; then
        VERDICT=$(cat gate-result.json | jq -r '.decision // "NO-SHIP"' 2>/dev/null || echo "NO-SHIP")
        SCORE=$(cat gate-result.json | jq -r '.trustScore // 0' 2>/dev/null || echo "0")
        CONFIDENCE=$(cat gate-result.json | jq -r '.confidence // 0' 2>/dev/null || echo "0")
        
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "  Shipgate Gate Result"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "  Verdict: $VERDICT"
        echo "  Trust Score: $SCORE/100"
        echo "  Confidence: $CONFIDENCE%"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        
        # Check for warnings (if WARN verdict exists)
        if echo "$VERDICT" | grep -qi "WARN"; then
          if [ "$SHIPGATE_FAIL_ON_WARN" = "true" ]; then
            echo "‚ö†Ô∏è  WARN verdict detected and FAIL_ON_WARN=true - failing build"
            exit 1
          else
            echo "‚ö†Ô∏è  WARN verdict detected - continuing (set FAIL_ON_WARN=true to fail on warnings)"
          fi
        fi
        
        # Fail on NO-SHIP
        if echo "$VERDICT" | grep -qi "NO-SHIP\|NO_SHIP"; then
          echo "‚ùå NO_SHIP verdict - blocking merge"
          cat gate-result.json | jq -r '.reasons[]? | "  - \(.reason)"' 2>/dev/null || true
          exit 1
        fi
        
        echo "‚úÖ SHIP verdict - code approved"
      else
        echo "‚ùå Error: gate-result.json not found"
        exit 1
      fi
      
      # Exit with gate command exit code if verdict parsing failed
      if [ $EXIT_CODE -ne 0 ] && [ "$VERDICT" != "NO-SHIP" ] && [ "$VERDICT" != "NO_SHIP" ]; then
        echo "‚ö†Ô∏è  Gate command exited with code $EXIT_CODE"
        exit $EXIT_CODE
      fi
  artifacts:
    reports:
      # GitLab Code Quality report (if available)
      codequality: gate-result.json
    paths:
      # Upload evidence bundle and results
      - gate-result.json
      - evidence/
    expire_in: 30 days
    when: always
  rules:
    # Run on merge requests and main branch
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  allow_failure: false
